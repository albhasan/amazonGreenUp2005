set no fetch;
set lang afl;

--load_module('/home/scidb/scidb_geoTrans/geoTransformation.txt'); --http://github.com/albhasan/scidb_geoTrans
load_library('savebmp');
load_library('geosdb');

--***********************************************************************************************
--RAIN ANOMALY COMPUTATION
--***********************************************************************************************

--Selects the data using:
	--spatial: TRMM ids overlapping AMAZON's MODIS tiles
	--temporal 1998-2006
	--quality: NOTE the relative error
	--store(between(filter(TRMM_3B43_SALESKA, time_id % 12 >= 6 and time_id % 12 <= 8 and relativeError < 1.00), 380, 160, 0, 561, 280, 107), TRMM_AMZ_JAS);
store(
	filter(
		apply( 
			between(
				filter(
					TRMM_3B43_SALESKA, time_id % 12 >= 6 and time_id % 12 <= 8 and relativeError < 1.00
				), 380, 160, 0, 561, 280, 107
			),Xcoord, id2coord(col_id, 1, 0.25, -179.875), Ycoord, id2coord(row_id, -1, 0.25, -49.875)
		),
		ispointinpolygon(
			double(Xcoord), 
			double(Ycoord), 
			'POLYGON((-68.571 4.758,-68.515 4.823,-68.366 4.878,-68.134 4.864,-68.004 4.864,-67.930 4.929,-67.802 4.961,-67.819 5.092,-67.820 5.093,-67.829 5.131,-67.848 5.306,-67.803 5.383,-67.769 5.406,-67.747 5.412,-67.688 5.448,-67.649 5.478,-67.615 5.548,-67.633 5.578,-67.642 5.612,-67.648 5.652,-67.651 5.683,-67.642 5.731,-67.620 5.792,-67.597 5.824,-67.576 5.845,-67.506 5.915,-67.478 5.941,-67.461 5.955,-67.426 5.976,-67.413 5.995,-67.434 6.038,-67.469 6.069,-67.485 6.097,-67.492 6.121,-67.489 6.153,-67.471 6.174,-67.353 6.226,-67.154 6.449,-67.051 6.695,-67.028 6.830,-66.958 6.844,-66.963 6.927,-67.028 6.988,-66.958 7.099,-66.796 7.234,-66.610 7.285,-66.466 7.457,-66.317 7.675,-65.932 7.671,-65.723 7.838,-65.555 7.884,-65.500 7.843,-65.239 7.847,-65.202 7.801,-65.105 7.829,-64.970 7.722,-64.868 7.657,-64.775 7.689,-64.649 7.727,-64.501 7.745,-64.491 7.987,-64.305 7.996,-64.254 8.038,-64.194 8.038,-64.106 7.968,-63.999 7.954,-63.915 7.954,-63.822 8.038,-63.743 8.131,-63.618 8.140,-63.413 8.159,-63.316 8.200,-63.232 8.284,-63.014 8.293,-62.958 8.256,-62.874 8.256,-62.740 8.335,-62.596 8.423,-62.503 8.488,-62.391 8.526,-62.238 8.567,-62.089 8.595,-62.024 8.544,-61.866 8.554,-61.778 8.591,-61.597 8.585,-61.520 8.524,-61.488 8.511,-61.393 8.474,-61.336 8.435,-61.259 8.451,-61.220 8.462,-61.168 8.495,-61.077 8.493,-61.073 8.463,-61.084 8.447,-61.086 8.421,-61.073 8.402,-61.017 8.469,-60.987 8.525,-60.981 8.564,-60.902 8.582,-60.715 8.604,-60.682 8.595,-60.659 8.579,-60.627 8.551,-60.465 8.528,-60.428 8.573,-60.408 8.621,-60.382 8.632,-60.236 8.627,-60.205 8.621,-60.139 8.602,-60.025 8.553,-60.006 8.544,-59.990 8.535,-59.987 8.529,-59.940 8.495,-59.929 8.484,-59.902 8.445,-59.889 8.421,-59.872 8.397,-59.855 8.379,-59.831 8.361,-59.786 8.340,-59.764 8.349,-59.779 8.380,-59.764 8.407,-59.668 8.359,-59.650 8.349,-59.355 8.173,-59.282 8.130,-59.242 8.107,-59.152 8.055,-59.129 8.039,-59.109 8.018,-59.093 7.987,-59.075 7.969,-58.943 7.851,-58.806 7.730,-58.768 7.679,-58.751 7.636,-58.717 7.594,-58.641 7.569,-58.485 7.368,-58.468 7.337,-58.465 7.135,-58.466 7.114,-58.481 7.009,-58.482 7.008,-58.391 6.880,-58.316 6.894,-58.255 6.876,-58.208 6.843,-58.172 6.812,-58.154 6.828,-58.038 6.815,-57.986 6.790,-57.966 6.775,-57.943 6.750,-57.927 6.731,-57.914 6.711,-57.897 6.689,-57.882 6.674,-57.757 6.569,-57.640 6.485,-57.594 6.434,-57.521 6.290,-57.519 6.270,-57.498 6.338,-57.469 6.340,-57.363 6.289,-57.336 6.274,-57.261 6.211,-57.220 6.169,-57.194 6.139,-57.177 6.108,-57.162 6.056,-57.135 5.954,-57.146 5.865,-57.099 5.857,-57.067 5.941,-56.992 5.989,-56.964 5.997,-56.700 5.965,-56.603 5.940,-56.554 5.948,-56.480 5.945,-56.260 5.889,-56.017 5.818,-55.910 5.778,-55.894 5.730,-55.898 5.674,-55.899 5.671,-55.885 5.683,-55.877 5.717,-55.891 5.775,-55.922 5.876,-55.855 5.948,-55.827 5.958,-55.768 5.967,-55.620 5.974,-55.548 5.977,-55.412 5.964,-55.377 5.959,-55.339 5.950,-55.268 5.924,-55.218 5.899,-55.175 5.907,-55.115 5.876,-55.114 5.839,-55.127 5.822,-55.104 5.839,-55.016 5.850,-54.946 5.846,-54.864 5.855,-54.887 5.879,-54.968 5.873,-54.995 5.865,-55.106 5.904,-55.144 5.934,-55.159 5.963,-55.047 6.001,-54.970 5.988,-54.876 5.985,-54.779 5.982,-54.709 5.962,-54.639 5.954,-54.344 5.906,-54.298 5.898,-54.204 5.879,-54.178 5.871,-54.025 5.818,-53.990 5.746,-54.006 5.721,-54.025 5.688,-53.980 5.691,-53.939 5.744,-53.911 5.750,-53.858 5.755,-53.750 5.731,-53.636 5.673,-53.522 5.604,-53.499 5.580,-53.494 5.572,-53.483 5.568,-53.408 5.548,-53.302 5.523,-53.186 5.499,-53.084 5.483,-52.973 5.473,-52.937 5.458,-52.886 5.420,-52.799 5.341,-52.787 5.321,-52.736 5.260,-52.611 5.129,-52.567 5.096,-52.422 4.992,-52.330 4.948,-52.289 4.938,-52.064 4.733,-52.023 4.685,-51.996 4.643,-51.985 4.613,-51.978 4.586,-51.956 4.492,-51.950 4.456,-51.950 4.423,-51.960 4.400,-52.001 4.368,-52.029 4.352,-52.040 4.334,-51.991 4.348,-51.951 4.372,-51.928 4.400,-51.923 4.427,-51.926 4.465,-51.929 4.486,-51.931 4.529,-51.931 4.569,-51.924 4.620,-51.915 4.646,-51.900 4.661,-51.861 4.659,-51.794 4.605,-51.767 4.537,-51.759 4.500,-51.756 4.477,-51.752 4.455,-51.744 4.421,-51.713 4.312,-51.702 4.287,-51.674 4.253,-51.655 4.225,-51.648 4.200,-51.648 4.167,-51.652 4.137,-51.661 4.081,-51.671 4.056,-51.665 4.058,-51.628 4.078,-51.605 4.118,-51.598 4.137,-51.532 4.175,-51.496 4.081,-51.439 3.994,-51.451 4.042,-51.471 4.077,-51.494 4.136,-51.502 4.156,-51.540 4.282,-51.546 4.303,-51.550 4.326,-51.551 4.352,-51.551 4.386,-51.539 4.407,-51.323 4.252,-51.251 4.174,-51.192 4.095,-51.183 4.077,-51.159 4.019,-51.157 3.917,-51.129 3.897,-51.108 3.928,-51.084 3.934,-51.071 3.908,-51.063 3.755,-51.070 3.658,-51.069 3.607,-51.057 3.400,-51.053 3.352,-51.047 3.303,-51.042 3.280,-51.015 3.151,-51.009 3.129,-50.984 3.064,-50.906 2.895,-50.842 2.762,-50.818 2.679,-50.808 2.641,-50.775 2.509,-50.671 2.186,-50.585 2.049,-50.493 1.907,-50.477 1.885,-50.458 1.864,-50.437 1.847,-50.394 1.841,-50.320 1.851,-50.185 1.846,-50.040 1.801,-50.007 1.786,-49.924 1.731,-49.880 1.602,-49.877 1.581,-49.874 1.560,-49.873 1.539,-49.870 1.467,-49.884 1.349,-49.948 1.298,-49.967 1.284,-50.014 1.276,-50.035 1.270,-50.078 1.256,-50.102 1.235,-50.062 1.231,-49.987 1.244,-49.958 1.253,-49.921 1.271,-49.903 1.257,-49.895 1.218,-49.895 1.196,-49.906 1.172,-49.933 1.140,-49.973 1.108,-50.229 0.910,-50.304 0.774,-50.344 0.744,-50.388 0.712,-50.412 0.701,-50.442 0.683,-50.464 0.644,-50.480 0.605,-50.499 0.569,-50.556 0.461,-50.566 0.443,-50.588 0.411,-50.632 0.358,-50.752 0.217,-50.774 0.198,-50.797 0.188,-50.816 0.194,-50.857 0.194,-50.904 0.182,-50.930 0.174,-50.950 0.160,-50.977 0.131,-50.997 0.104,-51.032 0.056,-51.052 0.021,-51.060 -0.003,-51.078 -0.028,-51.083 -0.031,-51.095 -0.040,-51.130 -0.060,-51.156 -0.072,-51.179 -0.075,-51.202 -0.080,-51.217 -0.094,-51.245 -0.115,-51.289 -0.169,-51.311 -0.203,-51.341 -0.254,-51.349 -0.274,-51.356 -0.304,-51.373 -0.346,-51.393 -0.381,-51.445 -0.466,-51.462 -0.483,-51.499 -0.508,-51.597 -0.613,-51.692 -0.730,-51.705 -0.764,-51.713 -0.847,-51.715 -0.885,-51.712 -0.930,-51.706 -0.958,-51.704 -1.001,-51.829 -1.118,-51.868 -1.127,-51.893 -1.128,-51.911 -1.144,-51.927 -1.176,-51.914 -1.223,-51.909 -1.278,-51.919 -1.312,-52.002 -1.384,-52.037 -1.396,-52.067 -1.397,-52.091 -1.395,-52.123 -1.383,-52.156 -1.352,-52.177 -1.332,-52.219 -1.322,-52.436 -1.424,-52.459 -1.459,-52.562 -1.506,-52.602 -1.505,-52.629 -1.512,-52.701 -1.543,-52.699 -1.580,-52.514 -1.551,-52.285 -1.512,-52.265 -1.518,-52.229 -1.555,-52.220 -1.585,-52.220 -1.627,-52.231 -1.645,-52.260 -1.659,-52.241 -1.682,-52.200 -1.669,-52.187 -1.644,-52.170 -1.622,-52.145 -1.605,-52.120 -1.597,-52.080 -1.604,-52.045 -1.587,-52.007 -1.594,-51.938 -1.567,-51.865 -1.530,-51.841 -1.507,-51.811 -1.482,-51.655 -1.380,-51.627 -1.371,-51.598 -1.366,-51.559 -1.357,-51.481 -1.325,-51.441 -1.305,-51.239 -1.186,-51.204 -1.121,-51.161 -1.088,-51.106 -1.060,-51.052 -1.038,-51.027 -1.023,-50.985 -0.976,-50.990 -0.957,-51.000 -0.933,-50.987 -0.906,-50.915 -0.888,-50.845 -0.893,-50.818 -0.906,-50.794 -1.151,-50.796 -1.189,-50.807 -1.229,-50.818 -1.257,-50.827 -1.318,-50.806 -1.422,-50.754 -1.526,-50.732 -1.545,-50.696 -1.577,-50.680 -1.595,-50.671 -1.613,-50.651 -1.719,-50.659 -1.749,-50.777 -1.868,-50.807 -1.876,-50.862 -1.842,-50.979 -1.809,-51.060 -1.789,-51.119 -1.798,-51.256 -1.731,-51.273 -1.687,-51.272 -1.659,-51.296 -1.638,-51.328 -1.625,-51.411 -1.759,-51.475 -1.871,-51.488 -1.912,-51.499 -1.950,-51.510 -2.002,-51.514 -2.024,-51.470 -2.216,-51.439 -2.257,-51.380 -2.297,-51.401 -2.267,-51.423 -2.251,-51.445 -2.223,-51.473 -2.050,-51.465 -2.017,-51.366 -1.846,-51.300 -1.744,-51.180 -1.802,-51.152 -1.820,-51.145 -1.849,-51.082 -1.905,-50.996 -1.989,-50.983 -2.007,-50.987 -2.088,-50.999 -2.137,-51.013 -2.158,-51.046 -2.172,-51.021 -2.322,-51.007 -2.363,-50.988 -2.395,-50.956 -2.422,-50.916 -2.444,-50.869 -2.453,-50.852 -2.480,-50.836 -2.485,-50.858 -2.444,-50.882 -2.437,-50.907 -2.429,-50.984 -2.361,-50.998 -2.317,-50.998 -2.283,-50.992 -2.178,-50.976 -2.047,-50.923 -1.970,-50.832 -2.017,-50.779 -2.095,-50.785 -2.146,-50.708 -2.201,-50.692 -2.182,-50.722 -2.149,-50.756 -2.101,-50.796 -2.016,-50.815 -1.966,-50.815 -1.938,-50.798 -1.917,-50.670 -1.788,-50.566 -1.794,-50.443 -1.835,-50.421 -1.871,-50.451 -1.891,-50.460 -1.910,-50.439 -1.928,-50.408 -1.930,-50.362 -1.926,-50.342 -1.919,-50.313 -1.893,-50.295 -1.882,-50.257 -1.861,-49.995 -1.799,-49.945 -1.812,-49.865 -1.860,-49.834 -1.880,-49.630 -1.853,-49.562 -1.827,-49.523 -1.794,-49.512 -1.777,-49.496 -1.762,-49.466 -1.740,-49.434 -1.724,-49.322 -1.691,-49.273 -1.695,-49.269 -1.744,-49.278 -1.768,-49.359 -1.907,-49.400 -2.003,-49.415 -2.099,-49.445 -2.168,-49.468 -2.189,-49.498 -2.235,-49.498 -2.292,-49.483 -2.326,-49.467 -2.363,-49.461 -2.384,-49.461 -2.408,-49.467 -2.458,-49.482 -2.543,-49.444 -2.496,-49.426 -2.466,-49.428 -2.430,-49.425 -2.375,-49.408 -2.328,-49.361 -2.245,-49.326 -2.182,-49.303 -2.123,-49.293 -2.079,-49.254 -1.977,-49.182 -1.876,-49.165 -1.858,-49.116 -1.855,-49.079 -1.833,-49.042 -1.837,-48.994 -1.831,-48.962 -1.818,-48.906 -1.731,-48.810 -1.622,-48.766 -1.550,-48.723 -1.476,-48.689 -1.447,-48.664 -1.463,-48.638 -1.479,-48.616 -1.468,-48.599 -1.449,-48.541 -1.527,-48.532 -1.560,-48.495 -1.600,-48.419 -1.638,-48.416 -1.618,-48.422 -1.590,-48.430 -1.569,-48.445 -1.542,-48.405 -1.477,-48.339 -1.475,-48.181 -1.444,-48.206 -1.428,-48.247 -1.424,-48.291 -1.425,-48.324 -1.428,-48.384 -1.434,-48.420 -1.443,-48.440 -1.452,-48.472 -1.453,-48.492 -1.439,-48.491 -1.387,-48.473 -1.283,-48.440 -1.264,-48.418 -1.274,-48.397 -1.288,-48.332 -1.295,-48.271 -1.135,-48.263 -1.096,-48.301 -1.019,-48.307 -1.006,-48.310 -0.985,-48.305 -0.962,-48.284 -0.923,-48.230 -0.846,-48.048 -0.686,-48.025 -0.681,-47.988 -0.715,-47.981 -0.735,-47.954 -0.754,-47.824 -0.658,-47.867 -0.840,-47.811 -0.721,-47.743 -0.578,-47.717 -0.708,-47.725 -0.724,-47.656 -0.714,-47.632 -0.698,-47.604 -0.676,-47.590 -0.656,-47.581 -0.626,-47.541 -0.614,-47.523 -0.624,-47.475 -0.713,-47.390 -0.791,-47.377 -0.754,-47.384 -0.730,-47.424 -0.701,-47.445 -0.696,-47.454 -0.678,-47.462 -0.600,-47.451 -0.573,-47.423 -0.560,-47.277 -0.577,-47.202 -0.619,-47.162 -0.685,-47.057 -0.731,-46.952 -0.681,-46.918 -0.818,-46.950 -0.838,-46.952 -0.876,-46.893 -0.843,-46.859 -0.757,-46.819 -0.691,-46.794 -0.706,-46.795 -0.739,-46.809 -0.792,-46.783 -0.820,-46.737 -0.808,-46.622 -0.804,-46.593 -0.846,-46.563 -0.954,-46.602 -1.015,-46.590 -1.001,-46.548 -0.983,-46.531 -1.007,-46.440 -1.021,-46.410 -1.015,-46.254 -0.967,-46.184 -0.935,-46.204 -1.037,-46.239 -1.121,-46.251 -1.156,-46.157 -1.124,-46.119 -1.084,-46.083 -1.157,-46.079 -1.188,-46.039 -1.188,-46.023 -1.173,-46.027 -1.138,-46.005 -1.090,-45.968 -1.056,-45.882 -1.119,-45.869 -1.149,-45.853 -1.214,-45.854 -1.238,-45.777 -1.246,-45.728 -1.158,-45.712 -1.197,-45.688 -1.347,-45.625 -1.349,-45.606 -1.318,-45.609 -1.287,-45.602 -1.258,-45.548 -1.255,-45.439 -1.289,-45.407 -1.334,-45.498 -1.443,-45.455 -1.488,-45.454 -1.524,-45.446 -1.522,-45.377 -1.392,-45.348 -1.315,-45.345 -1.293,-45.317 -1.293,-45.302 -1.316,-45.291 -1.359,-45.291 -1.396,-45.309 -1.419,-45.347 -1.455,-45.365 -1.519,-45.359 -1.694,-45.343 -1.715,-45.313 -1.722,-45.276 -1.714,-45.214 -1.654,-45.232 -1.621,-45.244 -1.589,-45.236 -1.551,-45.191 -1.498,-45.151 -1.458,-45.084 -1.442,-44.997 -1.467,-44.947 -1.480,-44.851 -1.409,-44.840 -1.445,-44.848 -1.468,-44.871 -1.481,-44.907 -1.524,-44.943 -1.580,-44.927 -1.597,-44.906 -1.617,-44.899 -1.593,-44.819 -1.554,-44.790 -1.586,-44.782 -1.605,-44.791 -1.683,-44.712 -1.772,-44.687 -1.796,-44.632 -1.767,-44.561 -1.795,-44.531 -1.810,-44.520 -1.837,-44.504 -1.886,-44.482 -1.965,-44.489 -2.026,-44.581 -2.148,-44.629 -2.202,-44.654 -2.259,-44.647 -2.302,-44.626 -2.262,-44.608 -2.235,-44.497 -2.127,-44.443 -2.125,-44.420 -2.135,-44.387 -2.177,-44.359 -2.273,-44.354 -2.298,-44.353 -2.320,-44.371 -2.378,-44.399 -2.388,-44.434 -2.390,-44.500 -2.449,-44.574 -2.545,-44.570 -2.595,-44.601 -2.653,-44.644 -2.746,-44.675 -2.891,-44.684 -2.973,-44.670 -2.995,-44.616 -3.012,-44.618 -3.033,-44.749 -3.171,-44.776 -3.183,-44.777 -3.207,-44.767 -3.267,-44.747 -3.417,-44.754 -3.529,-44.694 -3.642,-44.627 -3.709,-44.559 -3.807,-44.672 -3.935,-44.732 -4.025,-44.709 -4.160,-44.627 -4.393,-44.589 -4.505,-44.597 -4.701,-44.664 -4.858,-44.777 -4.948,-44.920 -5.084,-44.965 -5.226,-45.085 -5.399,-45.288 -5.504,-45.513 -5.654,-45.633 -5.714,-45.858 -5.744,-45.948 -5.842,-45.963 -5.985,-45.986 -6.030,-46.001 -6.172,-46.023 -6.233,-46.023 -6.285,-46.053 -6.375,-46.091 -6.473,-46.151 -6.555,-46.264 -6.631,-46.287 -6.801,-46.304 -6.764,-46.533 -6.707,-46.695 -6.621,-46.723 -6.469,-46.675 -6.288,-46.571 -6.164,-46.628 -6.050,-46.742 -5.946,-46.971 -5.927,-47.047 -5.803,-47.113 -5.660,-46.980 -5.603,-46.990 -5.498,-47.028 -5.384,-47.104 -5.289,-47.208 -5.241,-47.370 -5.108,-47.431 -5.073,-47.527 -5.035,-47.527 -5.035,-47.656 -5.051,-47.856 -4.975,-47.960 -5.051,-48.198 -5.146,-48.179 -5.232,-47.884 -5.241,-47.732 -5.232,-47.561 -5.327,-47.542 -5.432,-47.608 -5.517,-47.694 -5.422,-47.713 -5.508,-47.741 -5.593,-47.846 -5.689,-47.846 -5.746,-47.799 -5.927,-47.903 -5.907,-47.951 -5.765,-48.103 -5.660,-48.113 -5.774,-48.027 -5.927,-47.979 -6.088,-48.046 -6.174,-48.027 -6.307,-47.922 -6.440,-48.113 -6.650,-48.208 -6.640,-48.236 -6.469,-48.398 -6.450,-48.503 -6.374,-48.570 -6.345,-48.627 -6.488,-48.646 -6.650,-48.550 -6.774,-48.541 -6.878,-48.665 -6.993,-48.665 -7.249,-48.579 -7.288,-48.608 -7.373,-48.560 -7.506,-48.627 -7.592,-48.722 -7.506,-48.893 -7.526,-49.007 -7.478,-49.131 -7.535,-49.179 -7.602,-49.093 -7.659,-48.988 -7.725,-49.112 -7.802,-49.245 -7.878,-49.302 -7.982,-49.321 -8.068,-49.483 -8.087,-49.436 -8.258,-49.369 -8.354,-49.388 -8.449,-49.388 -8.563,-49.483 -8.649,-49.636 -8.706,-49.655 -8.611,-49.540 -8.468,-49.502 -8.363,-49.559 -8.325,-49.569 -8.173,-49.540 -8.059,-49.483 -7.982,-49.483 -7.925,-49.559 -7.878,-49.693 -7.925,-49.750 -7.916,-49.750 -7.830,-49.588 -7.716,-49.464 -7.621,-49.464 -7.497,-49.626 -7.411,-49.864 -7.459,-49.959 -7.602,-50.026 -7.763,-50.073 -7.859,-50.007 -8.020,-49.997 -8.173,-50.007 -8.268,-50.121 -8.354,-50.121 -8.477,-50.045 -8.563,-49.969 -8.630,-49.950 -8.725,-49.988 -8.772,-49.988 -8.915,-49.873 -8.953,-49.769 -8.906,-49.645 -8.839,-49.607 -8.877,-49.693 -8.991,-49.788 -9.029,-49.921 -9.039,-50.054 -9.105,-50.149 -9.153,-50.254 -9.258,-50.111 -9.343,-50.064 -9.477,-49.969 -9.343,-49.931 -9.486,-49.931 -9.648,-50.035 -9.715,-49.969 -9.791,-49.997 -9.934,-50.092 -9.895,-50.149 -9.705,-50.226 -9.658,-50.340 -9.772,-50.349 -9.924,-50.416 -10.048,-50.559 -10.143,-50.616 -10.276,-50.540 -10.390,-50.578 -10.486,-50.597 -10.600,-50.597 -10.724,-50.740 -10.676,-50.911 -10.628,-51.016 -10.657,-51.120 -10.781,-51.206 -10.885,-51.387 -10.781,-51.558 -10.704,-51.720 -10.685,-51.777 -10.809,-51.834 -10.914,-51.710 -10.980,-51.596 -10.980,-51.549 -11.076,-51.472 -11.199,-51.339 -11.209,-51.177 -11.104,-51.101 -11.161,-51.054 -11.276,-51.092 -11.390,-51.254 -11.323,-51.235 -11.418,-51.263 -11.552,-51.482 -11.571,-51.339 -11.694,-51.282 -11.856,-51.387 -11.932,-51.596 -11.999,-51.549 -12.094,-51.377 -12.085,-51.311 -12.189,-51.130 -12.218,-50.920 -12.284,-50.920 -12.484,-51.006 -12.361,-51.120 -12.361,-51.301 -12.342,-51.425 -12.389,-51.434 -12.532,-51.625 -12.627,-51.596 -12.399,-51.739 -12.361,-51.834 -12.513,-51.787 -12.646,-51.768 -12.760,-51.901 -12.846,-51.967 -12.694,-52.101 -12.722,-52.215 -12.894,-52.339 -13.065,-52.396 -13.189,-52.596 -13.293,-52.729 -13.350,-52.843 -13.274,-53.052 -13.312,-53.157 -13.436,-53.300 -13.398,-53.481 -13.446,-53.528 -13.560,-53.643 -13.503,-53.823 -13.512,-53.995 -13.550,-54.147 -13.541,-54.280 -13.598,-54.299 -13.741,-54.442 -13.712,-54.613 -13.560,-54.613 -13.398,-54.613 -13.236,-54.775 -13.284,-54.861 -13.408,-54.975 -13.465,-55.118 -13.341,-55.194 -13.132,-55.299 -12.970,-55.441 -12.779,-55.499 -12.618,-55.441 -12.503,-55.527 -12.332,-55.717 -12.199,-55.927 -12.265,-55.974 -12.361,-56.089 -12.313,-55.993 -12.180,-56.041 -12.104,-56.250 -12.227,-56.317 -12.389,-56.308 -12.551,-56.450 -12.589,-56.526 -12.684,-56.450 -12.875,-56.269 -12.951,-56.165 -12.789,-56.117 -12.979,-56.184 -13.112,-56.317 -13.189,-56.279 -13.303,-56.136 -13.408,-56.070 -13.569,-55.851 -13.626,-55.717 -13.712,-55.813 -13.769,-55.917 -13.826,-56.146 -13.779,-56.184 -13.883,-56.051 -13.988,-56.155 -14.036,-56.241 -14.188,-56.365 -14.036,-56.469 -13.845,-56.574 -13.684,-56.631 -13.864,-56.688 -13.979,-56.850 -13.922,-56.936 -13.912,-57.031 -13.969,-57.088 -13.779,-57.107 -13.674,-57.193 -13.569,-57.307 -13.560,-57.364 -13.455,-57.307 -13.236,-57.431 -13.274,-57.573 -13.341,-57.640 -13.389,-57.621 -13.255,-57.669 -13.093,-57.726 -13.027,-57.849 -13.103,-57.887 -13.160,-57.935 -13.074,-57.935 -12.722,-57.897 -12.608,-57.735 -12.560,-57.764 -12.446,-58.068 -12.513,-58.249 -12.437,-58.344 -12.541,-58.344 -12.741,-58.144 -12.770,-58.106 -12.865,-58.211 -12.932,-58.325 -12.922,-58.401 -12.998,-58.544 -13.122,-58.554 -13.274,-58.611 -13.408,-58.716 -13.341,-58.658 -13.198,-58.649 -13.017,-58.763 -13.103,-58.858 -13.255,-58.973 -13.379,-59.068 -13.293,-59.230 -13.341,-59.287 -13.446,-59.334 -13.598,-59.372 -13.722,-59.429 -13.579,-59.563 -13.531,-59.639 -13.398,-59.858 -13.436,-59.763 -13.617,-59.734 -13.693,-59.734 -13.883,-59.534 -13.883,-59.506 -14.102,-59.525 -14.274,-59.401 -14.378,-59.277 -14.464,-59.230 -14.578,-59.296 -14.616,-59.334 -14.807,-59.477 -14.949,-59.667 -14.968,-59.639 -15.121,-59.810 -15.140,-59.905 -15.244,-60.039 -15.340,-60.219 -15.387,-60.257 -15.216,-60.400 -15.083,-60.515 -15.127,-60.449 -15.199,-60.431 -15.218,-60.412 -15.239,-60.476 -15.340,-60.648 -15.283,-60.790 -15.225,-60.952 -15.092,-60.971 -15.016,-60.895 -14.892,-60.895 -14.788,-60.981 -14.645,-61.133 -14.626,-61.257 -14.826,-61.276 -14.940,-61.400 -15.007,-61.419 -14.911,-61.495 -14.873,-61.685 -14.873,-61.752 -14.978,-61.638 -15.007,-61.657 -15.083,-61.761 -15.140,-61.771 -15.225,-61.695 -15.321,-61.695 -15.444,-61.752 -15.511,-61.895 -15.540,-62.056 -15.616,-62.085 -15.739,-62.066 -15.901,-62.180 -15.911,-62.247 -16.101,-62.285 -16.158,-62.389 -16.263,-62.494 -16.206,-62.665 -16.310,-62.742 -16.387,-62.608 -16.539,-62.532 -16.586,-62.570 -16.691,-62.437 -16.682,-62.428 -16.834,-62.447 -16.948,-62.504 -16.901,-62.532 -16.815,-62.618 -16.796,-62.799 -16.891,-62.723 -16.977,-62.684 -17.043,-62.875 -17.043,-63.094 -17.043,-63.122 -16.967,-63.141 -16.834,-63.303 -16.739,-63.284 -16.843,-63.227 -16.948,-63.294 -17.034,-63.256 -17.148,-63.227 -17.272,-63.227 -17.376,-63.322 -17.367,-63.408 -17.424,-63.370 -17.519,-63.294 -17.567,-63.198 -17.500,-63.151 -17.624,-63.170 -17.700,-63.265 -17.757,-63.265 -17.967,-63.179 -18.005,-63.160 -18.119,-63.162 -18.121,-63.243 -18.237,-63.316 -18.282,-63.389 -18.145,-63.501 -18.145,-63.477 -17.953,-63.477 -17.816,-63.638 -17.704,-63.758 -17.623,-63.894 -17.632,-64.023 -17.575,-64.087 -17.487,-64.191 -17.415,-64.296 -17.455,-64.368 -17.455,-64.440 -17.343,-64.601 -17.302,-64.753 -17.214,-64.857 -17.246,-65.010 -17.222,-65.034 -17.118,-65.195 -17.182,-65.275 -17.030,-65.467 -17.054,-65.532 -16.965,-65.548 -16.885,-65.628 -16.789,-65.668 -16.741,-65.748 -16.709,-65.869 -16.548,-65.869 -16.468,-65.901 -16.355,-65.981 -16.331,-66.005 -16.179,-66.150 -16.115,-66.214 -16.010,-66.246 -15.938,-66.342 -15.858,-66.294 -15.786,-66.190 -15.721,-66.085 -15.609,-66.053 -15.529,-66.174 -15.320,-66.254 -15.240,-66.430 -15.144,-66.567 -15.055,-66.679 -15.023,-66.735 -15.055,-66.703 -15.136,-66.623 -15.224,-66.671 -15.280,-66.776 -15.256,-66.816 -15.176,-66.912 -15.224,-66.992 -15.256,-67.097 -15.152,-67.177 -15.007,-67.201 -14.967,-67.329 -14.975,-67.361 -15.087,-67.434 -15.063,-67.514 -14.959,-67.690 -14.927,-67.658 -15.047,-67.610 -15.192,-67.498 -15.248,-67.450 -15.376,-67.305 -15.545,-67.169 -15.657,-67.040 -15.754,-67.265 -15.721,-67.337 -15.609,-67.458 -15.529,-67.570 -15.400,-67.634 -15.288,-67.747 -15.288,-67.690 -15.408,-67.763 -15.497,-67.931 -15.521,-67.995 -15.408,-68.084 -15.192,-67.899 -15.304,-67.819 -15.232,-67.819 -15.112,-67.915 -14.967,-67.827 -14.919,-67.707 -14.791,-67.811 -14.646,-67.979 -14.494,-67.947 -14.357,-67.899 -14.285,-67.923 -14.132,-68.003 -14.028,-68.100 -13.900,-68.308 -13.715,-68.429 -13.667,-68.525 -13.771,-68.718 -13.723,-68.902 -13.691,-69.049 -13.678,-69.167 -13.667,-69.255 -13.579,-69.392 -13.571,-69.424 -13.659,-69.584 -13.579,-69.713 -13.555,-69.833 -13.531,-69.897 -13.394,-69.897 -13.314,-69.994 -13.193,-70.114 -13.057,-70.243 -13.129,-70.259 -13.201,-70.291 -13.322,-70.387 -13.234,-70.427 -13.226,-70.548 -13.282,-70.668 -13.250,-70.660 -13.041,-70.692 -12.872,-70.764 -12.744,-70.780 -12.616,-70.925 -12.527,-71.005 -12.616,-71.165 -12.704,-71.206 -12.616,-71.133 -12.511,-71.125 -12.399,-71.270 -12.246,-71.462 -12.142,-71.631 -12.118,-71.719 -12.062,-71.775 -11.909,-71.880 -11.950,-71.928 -12.030,-72.000 -12.038,-72.450 -11.917,-72.626 -11.974,-72.771 -12.030,-72.851 -12.158,-72.795 -12.343,-72.714 -12.447,-72.602 -12.551,-72.738 -12.648,-72.851 -12.664,-73.051 -12.664,-73.140 -12.567,-73.132 -12.431,-72.971 -12.455,-72.925 -12.219,-72.943 -11.998,-73.019 -11.901,-73.276 -11.781,-73.300 -11.572,-73.268 -11.412,-73.148 -11.364,-73.148 -11.187,-73.220 -11.075,-73.380 -11.131,-73.453 -11.067,-73.348 -10.946,-73.525 -10.938,-73.645 -11.019,-73.533 -11.251,-73.525 -11.396,-73.669 -11.452,-73.742 -11.340,-73.878 -11.428,-73.838 -11.596,-73.814 -11.741,-73.830 -11.837,-73.894 -11.966,-73.918 -12.078,-74.087 -12.102,-74.159 -12.014,-74.143 -11.829,-74.135 -11.637,-74.271 -11.508,-74.376 -11.356,-74.368 -11.227,-74.472 -11.211,-74.584 -11.275,-74.705 -11.163,-74.576 -11.067,-74.488 -10.914,-74.263 -10.922,-74.071 -10.994,-73.990 -11.091,-73.870 -10.986,-73.918 -10.898,-73.958 -10.746,-74.119 -10.633,-74.231 -10.449,-74.183 -10.377,-74.239 -10.280,-74.223 -9.983,-74.352 -9.919,-74.376 -9.718,-74.360 -9.518,-74.536 -9.301,-74.673 -9.117,-74.761 -9.205,-74.841 -9.285,-74.769 -9.494,-74.673 -9.574,-74.648 -9.743,-74.600 -9.823,-74.592 -9.967,-74.512 -10.023,-74.528 -10.200,-74.480 -10.320,-74.640 -10.385,-74.640 -10.481,-74.705 -10.497,-74.761 -10.641,-74.801 -10.649,-74.945 -10.665,-74.961 -10.569,-75.010 -10.473,-75.154 -10.641,-75.178 -10.481,-75.154 -10.312,-75.331 -10.264,-75.339 -10.096,-75.387 -10.015,-75.523 -10.023,-75.587 -9.895,-75.628 -9.759,-75.595 -9.502,-75.523 -9.438,-75.523 -9.285,-75.563 -9.084,-75.684 -9.036,-75.740 -8.804,-75.772 -8.635,-75.836 -8.507,-75.756 -8.386,-75.820 -8.266,-75.708 -8.202,-75.676 -8.025,-75.788 -7.897,-75.732 -7.808,-75.660 -7.712,-75.604 -7.664,-75.620 -7.495,-75.724 -7.495,-75.796 -7.648,-75.925 -7.600,-75.852 -7.479,-75.892 -7.271,-75.957 -7.102,-76.053 -7.086,-76.238 -7.142,-76.342 -7.255,-76.366 -7.407,-76.286 -7.536,-76.109 -7.656,-75.989 -7.776,-75.957 -7.929,-75.989 -8.105,-76.045 -7.977,-76.133 -7.929,-76.238 -7.824,-76.350 -7.800,-76.422 -7.728,-76.478 -7.656,-76.591 -7.784,-76.534 -7.977,-76.430 -8.121,-76.286 -8.282,-76.221 -8.499,-76.157 -8.627,-76.069 -8.796,-75.973 -9.084,-75.941 -9.245,-76.117 -9.117,-76.246 -8.675,-76.430 -8.434,-76.575 -8.258,-76.679 -8.121,-76.823 -7.897,-76.823 -7.600,-76.863 -7.447,-77.088 -7.279,-77.233 -7.046,-77.297 -6.837,-77.160 -6.861,-76.984 -6.910,-76.872 -6.741,-76.695 -6.757,-76.703 -6.556,-76.583 -6.613,-76.663 -6.316,-76.855 -6.171,-76.791 -6.083,-76.671 -6.147,-76.518 -6.332,-76.334 -6.492,-76.077 -6.444,-76.374 -6.284,-76.542 -6.139,-76.623 -5.963,-76.679 -5.850,-76.711 -5.714,-76.751 -5.585,-76.791 -5.457,-76.928 -5.449,-77.032 -5.577,-77.144 -5.545,-77.281 -5.481,-77.417 -5.425,-77.538 -5.248,-77.650 -5.104,-77.690 -4.935,-77.738 -4.799,-77.907 -4.983,-77.827 -5.080,-77.778 -5.200,-77.899 -5.232,-78.019 -5.080,-78.043 -4.975,-78.164 -4.967,-78.196 -5.112,-78.332 -5.200,-78.388 -5.304,-78.444 -5.497,-78.525 -5.601,-78.629 -5.634,-78.677 -5.786,-78.549 -6.067,-78.597 -6.115,-78.725 -5.850,-78.774 -5.634,-78.613 -5.529,-78.661 -5.417,-78.830 -5.280,-78.934 -5.024,-78.806 -5.136,-78.685 -5.288,-78.533 -5.361,-78.461 -5.200,-78.469 -5.048,-78.412 -4.919,-78.348 -4.791,-78.244 -4.654,-78.308 -4.566,-78.412 -4.622,-78.501 -4.783,-78.557 -4.654,-78.485 -4.494,-78.444 -4.349,-78.348 -4.189,-78.292 -4.309,-78.244 -4.261,-78.099 -4.341,-78.027 -4.470,-77.867 -4.446,-77.835 -4.261,-77.923 -4.213,-78.091 -4.173,-78.156 -4.061,-78.027 -4.036,-77.923 -4.012,-77.923 -3.860,-78.083 -3.780,-78.123 -3.659,-78.181 -3.472,-78.170 -3.451,-78.171 -3.447,-78.162 -3.430,-78.173 -3.391,-78.195 -3.370,-78.205 -3.343,-78.207 -3.339,-78.192 -3.312,-78.167 -3.292,-78.133 -3.272,-78.108 -3.254,-78.059 -3.193,-78.026 -3.134,-78.188 -3.114,-78.180 -3.033,-77.963 -2.945,-77.939 -2.785,-77.819 -2.728,-77.786 -2.600,-77.883 -2.504,-77.819 -2.399,-77.714 -2.303,-77.690 -2.167,-77.698 -2.086,-77.770 -2.086,-77.778 -1.982,-77.827 -1.918,-77.819 -1.789,-77.827 -1.629,-77.754 -1.533,-77.762 -1.460,-77.794 -1.372,-77.778 -1.195,-77.923 -1.236,-77.939 -1.115,-77.907 -1.019,-77.835 -0.891,-77.706 -0.899,-77.626 -0.963,-77.506 -0.923,-77.441 -0.666,-77.401 -0.561,-77.409 -0.465,-77.385 -0.385,-77.369 -0.273,-77.401 -0.072,-77.481 0.023,-77.465 0.120,-77.377 0.232,-77.344 0.373,-77.168 0.457,-77.040 0.577,-76.920 0.673,-76.823 0.826,-76.791 0.938,-76.671 0.938,-76.623 1.115,-76.518 1.179,-76.414 1.115,-76.302 1.155,-76.286 1.243,-76.173 1.291,-76.021 1.372,-75.925 1.388,-75.852 1.428,-75.804 1.532,-75.724 1.620,-75.628 1.701,-75.523 1.837,-75.427 1.893,-75.331 1.925,-75.258 2.038,-75.114 2.174,-75.026 2.182,-74.921 2.327,-74.881 2.391,-74.929 2.519,-74.913 2.624,-74.809 2.567,-74.695 2.441,-74.609 2.484,-74.502 2.577,-74.466 2.648,-74.516 2.719,-74.566 2.826,-74.566 2.891,-74.531 2.969,-74.424 3.019,-74.402 3.155,-74.345 3.212,-74.238 3.212,-74.131 3.091,-74.010 3.055,-74.067 2.912,-73.924 2.841,-73.895 2.734,-73.867 2.655,-73.931 2.548,-73.903 2.405,-73.824 2.448,-73.767 2.648,-73.803 2.791,-73.838 2.869,-73.853 3.069,-73.917 3.140,-73.974 3.233,-73.974 3.276,-74.088 3.333,-74.052 3.433,-73.967 3.569,-73.860 3.712,-73.767 3.647,-73.717 3.497,-73.581 3.369,-73.417 3.305,-73.296 3.148,-73.267 3.062,-73.231 2.919,-73.160 2.869,-73.046 2.819,-72.903 2.784,-72.817 2.776,-72.782 2.905,-72.867 3.105,-72.853 3.162,-72.710 3.212,-72.625 3.248,-72.225 3.269,-72.168 3.355,-72.132 3.526,-72.082 3.633,-72.011 3.762,-71.832 3.847,-71.682 3.869,-71.540 3.926,-71.383 3.990,-71.240 4.004,-70.947 4.004,-70.769 4.033,-70.597 4.154,-70.419 4.218,-70.298 4.283,-70.155 4.297,-69.998 4.318,-69.805 4.397,-69.619 4.468,-69.520 4.504,-69.277 4.404,-69.120 4.354,-68.970 4.425,-68.877 4.561,-68.799 4.668,-68.699 4.732,-68.571 4.758))'
		)
	)
	, TRMM_AMZ_JAS
);

--Calculates PRECIPITATION average and standard deviation JAS 1998 - 2006 excluding 2005
store(aggregate(filter(TRMM_AMZ_JAS, time_id < 90 or time_id > 92), avg(precipitation) as precipitation_avg_jas_2000_2006, stdev(precipitation) as precipitation_stdev_jas_2000_2006, col_id, row_id), TRMM_AMZ_AVG_1998_2006);

--Calculates PRECIPITATION average JAS 2005
store(aggregate(filter(TRMM_AMZ_JAS, time_id >= 90 and time_id <= 92), avg(precipitation) as precipitation_avg_jas_2005, avg(relativeError) as relativeError_avg_jas_2005, avg(gaugeRelativeWeighting) as gaugeRelativeWeighting_avg_jas_2005, col_id, row_id), TRMM_AMZ_AVG_2005);

--Join
store(join(TRMM_AMZ_AVG_1998_2006, TRMM_AMZ_AVG_2005), TRMM_AMZ_COMP);

--Calculate anomalies
store(apply(TRMM_AMZ_COMP, precipitation_anomaly, (precipitation_avg_jas_2005 - precipitation_avg_jas_2000_2006)/precipitation_stdev_jas_2000_2006), TRMM_AMZ_ANOM);

--Clean
remove(TRMM_AMZ_JAS);
remove(TRMM_AMZ_AVG_1998_2006);
remove(TRMM_AMZ_AVG_2005);
remove(TRMM_AMZ_COMP);
--remove(TRMM_AMZ_ANOM)




--***********************************************************************************************
--EVI2 ANOMALY COMPUTATION
--***********************************************************************************************

--Select the data using spatial (amazon MODIS tiles) temporal (JAS 2000-2006) and quality criteria
store(between(filter(MOD09Q1_SALESKA, time_id % 46 >= 23 and time_id % 46 <= 34 and quality = 4096), 48000, 38400, 0, 67199, 52799, 321), MODIS_AMZ_BQ_JAS);

--Compute EVI for each cell (10000 compensates the MODIS's scale factor)
store(apply(MODIS_AMZ_BQ_JAS, evi2, 2.5*((nir - red)/(nir + 2.4 * red + (1 * 10000)))), MODIS_AMZ_BQ_JAS_EVI2);

--Calculate EVI2's average and standard deviation JAS 2000 - 2006 excluding 2005
store(aggregate(filter(MODIS_AMZ_BQ_JAS_EVI2, time_id < 253 or time_id > 264), avg(evi2) as evi2_avg_jas_2000_2006, stdev(evi2) as evi2_stdev_jas_2000_2006, col_id, row_id), MODIS_AMZ_BQ_JAS_EVI2_AVG_2000_2006);

--Calculate EVI2's average JAS 2005
store(aggregate(filter(MODIS_AMZ_BQ_JAS_EVI2, time_id >= 253 or time_id <= 264), avg(evi2) as evi2_avg_jas_2005, col_id, row_id), MODIS_AMZ_BQ_JAS_EVI2_AVG_2005);

--Join
store(join(MODIS_AMZ_BQ_JAS_EVI2_AVG_2000_2006, MODIS_AMZ_BQ_JAS_EVI2_AVG_2005), MODIS_AMZ_EVI2_COMP);

--Calculate Anomalies
store(apply(MODIS_AMZ_EVI2_COMP, evi2_anomaly, (evi2_avg_jas_2005 - evi2_avg_jas_2000_2006)/evi2_stdev_jas_2000_2006), MODIS_AMZ_EVI2_ANOM);




--***********************************************************************************************
--FILTER EVI2 ANOMALY USING RAIN ANOMALY
--***********************************************************************************************
store(project(apply(MODIS_AMZ_EVI2_ANOM, xModSin, id2coord(col_id, 1, 231.656358263889, -20014993.5258209), yModSin, id2coord(row_id, -1, 231.656358263889, -10007438.8488209)), xModSin, yModSin), MODSIN);
store(apply(MODSIN, lonSphericRAD, sinusoidal2sphericLON(xModSin, sinusoidal2sphericLAT(yModSin, 6371007.181), 6371007.181, 0), latSphericRAD, sinusoidal2sphericLAT(yModSin, 6371007.181)), MODSIN_SPHERIC);
store(apply(MODSIN_SPHERIC, xGeocen, spheric2geocentricX(6371007.181, lonSphericRAD, latSphericRAD), yGeocen, spheric2geocentricY(6371007.181, lonSphericRAD, latSphericRAD), zGeocen, spheric2geocentricZ(6371007.181, latSphericRAD)), MODSIN_SPHERIC_GEOCEN);
store(apply(MODSIN_SPHERIC_GEOCEN, lonWGS84DD, rad2dd(geocentric2ellipsoidalLON(xGeocen, yGeocen)), latWGS84DD, rad2dd(geocentric2ellipsoidalLAT(6378137, 1/298.257223563, xGeocen, yGeocen, zGeocen))), MODSIN_SPHERIC_GEOCEN_WGS84);
--		Create a lookup array with the TRMM ids and get the TRMM data
store(project(apply(MODSIN_SPHERIC_GEOCEN_WGS84, TRMM_col_id, int64(coord2id(lonWGS84DD, 1, 0.25, -179.875)), TRMM_row_id, int64(coord2id(latWGS84DD, -1, 0.25, -49.875))), TRMM_col_id, TRMM_row_id), LU_TRMM_id);
store(lookup(LU_TRMM_id, TRMM_AMZ_ANOM), LU_TRMM_data);
--		Join the results
store(join(MODIS_AMZ_EVI2_ANOM, LU_TRMM_data), MODIS_TRMM_AMZ);



--Filter the EVI2 using the rain anomalies and the drought area
--ORIGINAL SALESKA FILTER 
store(between(filter(MODIS_TRMM_AMZ, precipitation_anomaly < -1), 48000, 43200, 62399, 52799), MODIS_TRMM_AMZ_EVIANOM);
--RAIN FILTER DIVIDED BY 10 --store(between(filter(MODIS_TRMM_AMZ, precipitation_anomaly < -0.1), 48000, 43200, 62399, 52799), MODIS_TRMM_AMZ_EVIANOM);


--Histogram building
--	Adapted from www.scidb.org/forum/viewtopic.php?f=15&t=348&p=2635&hilit=histogram
store(attribute_rename(project(unpack(MODIS_TRMM_AMZ_EVIANOM, i), evi2_anomaly), evi2_anomaly, z), z);
--FREEDMAN-DIACONIS RULE for bin size estimation
--	aggregate(z, count(z));
--		757412
--	quantile(z, 4);
--		{0} 0,-0.482387
--		{1} 0.25,-0.015057
--		{2} 0.5,0.0345329
--		{3} 0.75,0.0679827
--		{4} 1,0.555779
--	IQR = 0.0679827 - (-0.015057) = 0.0830397
--	n = 757412
--	BIN SIZE = 2 * IQR * n^(1/3) = 2 * 0.0830397 * 757412^(-1/3) = 0.0018219581
--	aggregate(z, min(z), max(z));
--		-0.482387,0.555779
--	BIN NUMBER  = (0.555779 - (-0.482387))/0.0018219581 = 569.8078347685
--
--10 bins
--project(apply(redimension(substitute(apply(cross_join(z, aggregate(z, min(z) as min, max(z) as max)), t, int64(9 * (z - min)/(max - min))),build(<v:int64>[i=0:0,1,0],0), t), <count:uint64 null, min:double null, max:double null>[t=0:*,1000000,0], count(t) as count), x, t * (max - min)/9.0 + min), x, count);
--
--570 BINS
store(project(apply(redimension(substitute(apply(cross_join(z, aggregate(z, min(z) as min, max(z) as max)), t, int64(569 * (z - min)/(max - min))),build(<v:int64>[i=0:0,1,0],0), t), <count:uint64 null, min:double null, max:double null>[t=0:*,1000000,0], count(t) as count), x, t * (max - min)/569.0 + min), x, count), MODIS_TRMM_AMZ_EVIANOM_HISTOGRAM);



--Clean
remove(MODIS_AMZ_BQ_JAS);
remove(MODIS_AMZ_BQ_JAS_EVI2);
remove(MODIS_AMZ_BQ_JAS_EVI2_AVG_2000_2006);
remove(MODIS_AMZ_BQ_JAS_EVI2_AVG_2005);
remove(MODIS_AMZ_EVI2_COMP);
remove(MODIS_AMZ_EVI2_ANOM);
remove(MODSIN);
remove(MODSIN_SPHERIC);
remove(MODSIN_SPHERIC_GEOCEN);
remove(MODSIN_SPHERIC_GEOCEN_WGS84);
remove(LU_TRMM_id);
remove(LU_TRMM_data);
--remove(MODIS_TRMM_AMZ);
--remove(MODIS_TRMM_AMZ_EVIANOM);
remove(z);
--remove(MODIS_TRMM_AMZ_EVIANOM_HISTOGRAM);




--***********************************************************************************************
--EXPORT RESULTS AS IMAGE
--***********************************************************************************************
--	CREATE ARRAY TEST_BMP <r:uint8, g:uint8, b:uint8> [x=0:2,10,0, y=0:2,10,0];
--	INSERT INTO TEST_BMP '[[(0, 0, 0) (10, 10, 10) (100, 100, 100)] [(0, 250, 125) (125, 250, 0) (100, 100, 100)] [(250, 250, 250) (200, 200, 200) (150, 150, 150)]]';

--Mape anomalies to pixel values
--	aggregate(MODIS_TRMM_AMZ, min( evi2_anomaly)); = -2.217702724
--	aggregate(MODIS_TRMM_AMZ, max( evi2_anomaly)); = 2.35306109483
--  (2.5 - (-2.5))/255 = 0.0196078431372549
--	pixel value = (evi2_anomaly + 2.5)/0.0196078431372549
--store(apply(project(apply(MODIS_TRMM_AMZ, r, uint8((evi2_anomaly + 2.5)/0.0196078431372549)), r), g, uint8(r), b, uint8(r)), evi2anomBMP);


--Apply color codes to evi2 anomalies
--     evi2_anomaly
--             -2,      -1.5,       -1,         1,         1.5,        2
--     #481316", "#E51D24", "#F47E56", "#F7F7B6", "#58B734", "#259B43", "#184621

--Original Saleska's classification
--store(project(apply(MODIS_TRMM_AMZ, r, uint8(iif(evi2_anomaly < -2, 72,  iif(evi2_anomaly >= -2 and evi2_anomaly < -1.5, 229, iif(evi2_anomaly >= -1.5 and evi2_anomaly < -1, 244, iif(evi2_anomaly >= -1 and evi2_anomaly < 1, 247, iif(evi2_anomaly >= 1 and evi2_anomaly < 1.5, 88, iif(evi2_anomaly >= 1.5 and evi2_anomaly < 2, 37, iif(evi2_anomaly >= 2, 24, 0)))))))), g, uint8(iif(evi2_anomaly < -2, 19, iif(evi2_anomaly >= -2 and evi2_anomaly < -1.5, 29, iif(evi2_anomaly >= -1.5 and evi2_anomaly < -1, 126, iif(evi2_anomaly >= -1 and evi2_anomaly < 1, 247, iif(evi2_anomaly >= 1 and evi2_anomaly < 1.5, 183, iif(evi2_anomaly >= 1.5 and evi2_anomaly < 2, 155, iif(evi2_anomaly >= 2, 70, 0)))))))), b, uint8(iif(evi2_anomaly < -2, 22, iif(evi2_anomaly >= -2 and evi2_anomaly < -1.5, 36, iif(evi2_anomaly >= -1.5 and evi2_anomaly < -1, 86, iif(evi2_anomaly >= -1 and evi2_anomaly < 1, 182, iif(evi2_anomaly >= 1 and evi2_anomaly < 1.5, 52, iif(evi2_anomaly >= 1.5 and evi2_anomaly < 2, 67, iif(evi2_anomaly >= 2, 33, 0))))))))), r, g , b), evi2anomBMP);

--Saleska's classification (interval's limits divided by 10)
store(
	project(
		apply(
			MODIS_TRMM_AMZ, 
			r, uint8(
				iif(evi2_anomaly < -0.2, 72, 
					iif(evi2_anomaly >= -0.2 and evi2_anomaly < -0.15, 229,
						iif(evi2_anomaly >= -0.15 and evi2_anomaly < -0.1, 244,
							iif(evi2_anomaly >= -0.1 and evi2_anomaly < 0.1, 247,
								iif(evi2_anomaly >= 0.1 and evi2_anomaly < 0.15, 88,
									iif(evi2_anomaly >= 0.15 and evi2_anomaly < 0.2, 37,
										iif(evi2_anomaly >= 0.2, 24, 0)
									)
								)
							)
						)
					)
				)
			), 
			g, uint8(
				iif(evi2_anomaly < -0.2, 19, 
					iif(evi2_anomaly >= -0.2 and evi2_anomaly < -0.15, 29,
						iif(evi2_anomaly >= -0.15 and evi2_anomaly < -0.1, 126,
							iif(evi2_anomaly >= -0.1 and evi2_anomaly < 0.1, 247,
								iif(evi2_anomaly >= 0.1 and evi2_anomaly < 0.15, 183,
									iif(evi2_anomaly >= 0.15 and evi2_anomaly < 0.2, 155,
										iif(evi2_anomaly >= 0.2, 70, 0)
									)
								)
							)
						)
					)
				)
			), 
			b, uint8(
				iif(evi2_anomaly < -0.2, 22, 
					iif(evi2_anomaly >= -0.2 and evi2_anomaly < -0.15, 36,
						iif(evi2_anomaly >= -0.15 and evi2_anomaly < -0.1, 86,
							iif(evi2_anomaly >= -0.1 and evi2_anomaly < 0.1, 182,
								iif(evi2_anomaly >= 0.1 and evi2_anomaly < 0.15, 52,
									iif(evi2_anomaly >= 0.15 and evi2_anomaly < 0.2, 67,
										iif(evi2_anomaly >= 0.2, 33, 0)
									)
								)
							)
						)
					)
				)
			)
		), r, g , b
	), evi2anomBMP
);
savebmp(evi2anomBMP, '/home/scidb/evi2anom.bmp');


--Clean
remove(evi2anomBMP);



